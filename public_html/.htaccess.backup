# ========================================================================
# FARHAN LOGISTICS - SECURITY & ROUTING CONFIGURATION
# Apache .htaccess with industry-standard security measures
# ========================================================================

# ========================================================================
# 1. SECURITY HEADERS
# ========================================================================

<IfModule mod_headers.c>
    # Prevent clickjacking attacks
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # XSS Protection
    Header always set X-XSS-Protection "1; mode=block"
    
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Content Security Policy (adjust domains as needed)
    Header always set Content-Security-Policy "default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self'; frame-ancestors 'self';"
    
    # Permissions Policy
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=()"
    
    # Remove Server signature
    Header always unset X-Powered-By
    Header unset X-Powered-By
    
    # HTTPS Strict Transport Security (uncomment when SSL is active)
    # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
</IfModule>

# Hide server signature
ServerSignature Off

# ========================================================================
# 2. FILE & DIRECTORY PROTECTION
# ========================================================================

# Disable Directory Browsing
Options -Indexes

# Disable MultiViews
Options -MultiViews

# Protect sensitive files
<FilesMatch "^(\.htaccess|\.htpasswd|\.env|composer\.json|composer\.lock|package\.json|package-lock\.json|database_schema\.sql|\.git.*|security\.php|db\.php|config\.php)$">
    Require all denied
</FilesMatch>

# Block access to backup and log files
<FilesMatch "\.(bak|backup|old|log|sql|md|txt|sh|ini|config)$">
    Require all denied
</FilesMatch>

# Protect README and documentation files
<FilesMatch "^(README|CHANGELOG|LICENSE|CONTRIBUTING|SECURITY|\.md)">
    Require all denied
</FilesMatch>

# Protect storage/logs directory
<DirectoryMatch "storage/logs">
    Require all denied
</DirectoryMatch>

# Prevent PHP execution in uploads directory
<DirectoryMatch "uploads">
    <FilesMatch "\.php$">
        Require all denied
    </FilesMatch>
</DirectoryMatch>

# ========================================================================
# 3. BLOCK MALICIOUS REQUESTS
# ========================================================================

<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
    
    # Block suspicious user agents
    RewriteCond %{HTTP_USER_AGENT} (nikto|sqlmap|fimap|nessus|openvas|metasploit|havij|acunetix|nmap) [NC]
    RewriteRule ^(.*)$ - [F,L]
    
    # Block malicious query strings
    RewriteCond %{QUERY_STRING} (<|%3C)([^s]*s)+cript.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} (union.*select|insert.*into|drop.*table|update.*set|delete.*from) [NC,OR]
    RewriteCond %{QUERY_STRING} (bash|git|hg|log|svn|swp|cvs|etc/passwd|boot\.ini) [NC]
    RewriteRule ^(.*)$ - [F,L]
    
    # ========================================================================
    # 4. ROUTING (after security checks)
    # ========================================================================
    
    # Skip rewriting for static assets
    RewriteCond %{REQUEST_URI} \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|webp|pdf)$ [NC]
    RewriteRule ^ - [L]
    
    # Skip if the actual file exists
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteRule ^ - [L]
    
    # Route everything else through router.php
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ router.php [QSA,L]
</IfModule>

# ========================================================================
# 5. PHP SECURITY SETTINGS
# ========================================================================

# Limit file upload size
php_value upload_max_filesize 20M
php_value post_max_size 22M
php_value max_execution_time 300
php_value max_input_time 300
php_value memory_limit 256M

# Remove PHP version from headers
php_flag expose_php Off

# Session security
php_value session.cookie_httponly 1
php_value session.use_only_cookies 1
php_value session.cookie_samesite "Lax"

# Error handling (production mode)
php_flag display_errors Off
php_flag display_startup_errors Off
php_value error_reporting 0
php_flag log_errors On

# Disable dangerous PHP functions (may not be supported on all hosts)
# php_value disable_functions "exec,passthru,shell_exec,system,proc_open,popen"

# ========================================================================
# 6. PERFORMANCE OPTIMIZATION
# ========================================================================

# GZIP Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript
    AddOutputFilterByType DEFLATE application/javascript application/json application/xml
</IfModule>

# Browser Caching
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Images
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    
    # Fonts
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    
    # Others
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType text/html "access plus 0 seconds"
</IfModule>

# Cache-Control Headers
<IfModule mod_headers.c>
    # Cache static assets
    <FilesMatch "\.(jpg|jpeg|png|gif|webp|svg|css|js|ico|woff|woff2|ttf|eot)$">
        Header set Cache-Control "max-age=31536000, public, immutable"
    </FilesMatch>
    
    # Don't cache dynamic content
    <FilesMatch "\.(html|htm|php)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires 0
    </FilesMatch>
</IfModule>

# ========================================================================
# 7. DEFAULT SETTINGS
# ========================================================================

# Default Document Order
DirectoryIndex index.php index.html

# UTF-8 Encoding
AddDefaultCharset UTF-8

# ========================================================================
# 8. HTTPS REDIRECT (Enable after SSL certificate is installed)
# ========================================================================

# <IfModule mod_rewrite.c>
#     RewriteEngine On
#     RewriteCond %{HTTPS} off
#     RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [R=301,L]
# </IfModule>
